# Marzban + Nginx + WARP Docker Setup

## –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ **Marzban** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π **Xray REALITY**, **Nginx** –≤ –∫–∞—á–µ—Å—Ç–≤–µ reverse proxy –∏ **Cloudflare WARP** –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫. –¢–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **MySQL** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
.
‚îú‚îÄ‚îÄ docker-compose.yaml
‚îú‚îÄ‚îÄ marzban
‚îÇ   ‚îî‚îÄ‚îÄ xray_config.json
‚îú‚îÄ‚îÄ nginx
‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf
‚îÇ   ‚îî‚îÄ‚îÄ proxy.conf
‚îî‚îÄ‚îÄ .env
```

---

## üß© –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| **Marzban** | –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Xray/V2Ray |
| **MySQL** | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Marzban |
| **Nginx** | Reverse proxy —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π SNI routing |
| **WARP** | SOCKS5 –ø—Ä–æ–∫—Å–∏ –æ—Ç Cloudflare –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π |
| **Xray REALITY** | –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –æ–±—Ö–æ–¥–∞ DPI |

---

## üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone https://github.com/yourusername/marzban-docker.git
cd marzban-docker
```

---

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `.env` —Ñ–∞–π–ª–∞

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `.env` –∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```env
# Marzban - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–∞–Ω–µ–ª–∏
SUDO_USERNAME=admin
SUDO_PASSWORD=your_secure_password

# MySQL - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
MYSQL_ROOT_PASSWORD=your_secure_root_password
MYSQL_PASSWORD=your_secure_db_password

# –î–æ–º–µ–Ω –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫
XRAY_SUBSCRIPTION_URL_PREFIX=https://yourdomain.com
```

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–¥–µ–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏.

---

### 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π REALITY

#### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è privateKey –∏ publicKey:

```bash
docker exec marzban xray x25519
```

–†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–∏–º:
```
Private key: 4ErnwFwwdsR0eq2np73JuPysFiEVi1xIVNKpRezc6TE
Public key: 7kD0U9HhJkLmN8pQrS2tV4wXyZ1aB3cD5eF6gH7jK9m
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ `Private key` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray.

#### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è shortId:

```bash
openssl rand -hex 8
```

–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: `8d9b438b097eb1ca`

---

### 4. –í—ã–±–æ—Ä —Å–∞–π—Ç–∞ –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏

–î–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã REALITY –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å–∞–π—Ç –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É—Ç–∏–ª–∏—Ç—É **RealiTLScanner**:

1. –°–∫–∞—á–∞–π—Ç–µ —É—Ç–∏–ª–∏—Ç—É:
```bash
wget https://github.com/XTLS/RealiTLScanner/releases/latest/download/RealiTLScanner-linux-64
chmod +x RealiTLScanner-linux-64
```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫–∞–Ω–µ—Ä:
```bash
./RealiTLScanner-linux-64 -addr –≤–∞—à_–∞–¥—Ä–µ—Å_—Å–µ—Ä–≤–µ—Ä–∞
```

3. –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –¥–æ–º–µ–Ω –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

---

### 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx —Å –º–æ–¥—É–ª–µ–º stream

–î–ª—è —Ä–∞–±–æ—Ç—ã SNI routing –Ω–µ–æ–±—Ö–æ–¥–∏–º –º–æ–¥—É–ª—å `ngx_stream_module`. –í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:


#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ Ubuntu/Debian

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx —Å –º–æ–¥—É–ª–µ–º stream
sudo apt update
sudo apt install nginx-full

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–æ–¥—É–ª—è
nginx -V 2>&1 | grep -o with-stream
```

#### –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
sudo apt install build-essential libpcre3-dev zlib1g-dev

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ Nginx
wget http://nginx.org/download/nginx-1.24.0.tar.gz
tar -zxpf nginx-1.24.0.tar.gz
cd nginx-1.24.0

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º stream
./configure --with-stream --with-http_ssl_module --with-http_v2_module

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞
make
sudo make install
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤

–î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–∞–∫–µ—Ç—ã —Å –ø–æ–ª–Ω–æ–π —Å–±–æ—Ä–∫–æ–π:

```bash
# CentOS/RHEL
sudo yum install nginx-mod-stream

# –ó–∞—Ç–µ–º –≤ nginx.conf –¥–æ–±–∞–≤—å—Ç–µ:
load_module modules/ngx_stream_module.so;
```

---

### 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Xray REALITY

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `marzban/xray_config.json` –∏ –∑–∞–º–µ–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è:

- `"privateKey"` ‚Äî –≤–∞—à –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ —à–∞–≥–∞ 3
- `"shortIds"` ‚Äî –≤–∞—à shortId –∏–∑ —à–∞–≥–∞ 3
- `"dest"` ‚Äî –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∞–π—Ç –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏
- `"serverNames"` ‚Äî –¥–æ–º–µ–Ω—ã –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏

–ü—Ä–∏–º–µ—Ä:
```json
"realitySettings": {
  "show": false,
  "dest": "www.tradingview.com:443",
  "xver": 0,
  "serverNames": [
    "tradingview.com",
    "www.tradingview.com"
  ],
  "privateKey": "4ErnwFwwdsR0eq2np73JuPysFiEVi1xIVNKpRezc6TE",
  "shortIds": [
    "8d9b438b097eb1ca"
  ]
}
```

---

### 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

–î–ª—è —Ä–∞–±–æ—Ç—ã Nginx –Ω–µ–æ–±—Ö–æ–¥–∏–º SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Let's Encrypt:

```bash
sudo certbot certonly --standalone -d yourdomain.com
```

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—É—Ç–∏ –≤ `nginx/proxy.conf` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—é –≤–∞—à–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:

```nginx
ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
```

---

### 8. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–º–µ–Ω–∞

–ó–∞–º–µ–Ω–∏—Ç–µ `marzban.nd.home-local.site` –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö:

- `nginx/nginx.conf`
- `nginx/proxy.conf`
- `.env`

---

### 9. –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

```bash
docker-compose up -d
```

---

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
docker logs marzban
docker logs mysql
docker logs warp_v3
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
docker-compose restart
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
docker-compose down
```

---

## üåê –î–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ –∞–¥—Ä–µ—Å—É:

```
https://yourdomain.com/dashboard
```

–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å —É–∫–∞–∑–∞–Ω—ã –≤ `.env`:

```
Username: admin
Password: your_secure_password
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–∞–Ω–µ–ª–∏ Marzban –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–ª–∏–µ–Ω—Ç Xray –∏–ª–∏ V2Ray.

---

## üìå –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç—ã `80`, `443`, `10000` –æ—Ç–∫—Ä—ã—Ç—ã.
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä `.home-local.site`), –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –µ–≥–æ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º DNS.
- –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å fail2ban –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

